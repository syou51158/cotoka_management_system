<?php
// å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
require_once '../config/config.php';
require_once '../classes/Database.php';
require_once '../includes/functions.php';

// ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’æ˜ç¤ºçš„ã«è¨­å®š
date_default_timezone_set('Asia/Tokyo');

// ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã¾ã é–‹å§‹ã•ã‚Œã¦ã„ãªã„å ´åˆã®ã¿ï¼‰
if (session_status() == PHP_SESSION_NONE) {
    session_start();
}

// ã‚µãƒ­ãƒ³IDã¨é¸æŠã•ã‚ŒãŸã‚µãƒ¼ãƒ“ã‚¹ã®å–å¾—ã¨æ¤œè¨¼
$salon_id = $_SESSION['booking_salon_id'] ?? null;
$services = $_SESSION['booking_services'] ?? null;

if (!$salon_id) {
    $_SESSION['error_message'] = "ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒåˆ‡ã‚Œã¾ã—ãŸã€‚æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚";
    header('Location: index.php');
    exit;
}

if (empty($services)) {
    $_SESSION['error_message'] = "ã‚µãƒ¼ãƒ“ã‚¹ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚";
    header('Location: select_service.php');
    exit;
}

// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶š
try {
    $db = new Database();
    $conn = $db->getConnection();
} catch (Exception $e) {
    error_log("ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼ï¼š" . $e->getMessage());
    $_SESSION['error_message'] = "ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚";
    header('Location: error.php');
    exit;
}

// ã‚µãƒ­ãƒ³æƒ…å ±ã®å–å¾—
try {
    $stmt = $conn->prepare("
        SELECT 
            s.salon_id,
            s.name as salon_name,
            s.address,
            s.phone,
            s.business_hours
        FROM salons s
        WHERE s.salon_id = :salon_id AND s.status = 'active'
    ");
    $stmt->bindParam(':salon_id', $salon_id);
    $stmt->execute();
    $salon = $stmt->fetch(PDO::FETCH_ASSOC);
    
    if (!$salon) {
        throw new Exception("ã‚µãƒ­ãƒ³æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
    }
    
    // å–¶æ¥­æ™‚é–“ã®è§£æï¼ˆJSONå½¢å¼ã§ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã¨ä»®å®šï¼‰
    $business_hours = [];
    if (!empty($salon['business_hours'])) {
        $business_hours = json_decode($salon['business_hours'], true) ?? [];
    }

    // ã‚µãƒ­ãƒ³ã®å–¶æ¥­æ™‚é–“ã‚’ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ã‚‚å–å¾—ï¼ˆå„ªå…ˆã—ã¦ä½¿ç”¨ï¼‰
    $stmt = $conn->prepare("
        SELECT 
            day_of_week,
            open_time,
            close_time,
            is_closed
        FROM salon_business_hours
        WHERE salon_id = :salon_id
        ORDER BY day_of_week
    ");
    $stmt->bindParam(':salon_id', $salon_id);
    $stmt->execute();
    $db_business_hours = $stmt->fetchAll(PDO::FETCH_ASSOC);
    
    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å–å¾—ã—ãŸå–¶æ¥­æ™‚é–“ãŒã‚ã‚‹å ´åˆã¯å„ªå…ˆã—ã¦ä½¿ç”¨
    if (!empty($db_business_hours)) {
        // é…åˆ—ã‚’åˆæœŸåŒ–
        $business_hours = [];
        foreach ($db_business_hours as $hour) {
            // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨åŒã˜0-6ã®æ›œæ—¥è¡¨è¨˜ã«çµ±ä¸€ï¼ˆ0: æ—¥ - 6: åœŸï¼‰
            $day = $hour['day_of_week']; 
            if ($hour['is_closed']) {
                $business_hours[$day] = ["start" => "", "end" => ""];
            } else {
                $business_hours[$day] = [
                    "start" => substr($hour['open_time'], 0, 5),
                    "end" => substr($hour['close_time'], 0, 5)
                ];
            }
        }
        debug_log("ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å–¶æ¥­æ™‚é–“ã‚’å–å¾—ã—ã¾ã—ãŸï¼š" . json_encode($business_hours));
    }
    
} catch (Exception $e) {
    error_log("ã‚µãƒ­ãƒ³æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼ï¼š" . $e->getMessage());
    $_SESSION['error_message'] = $e->getMessage();
    header('Location: error.php');
    exit;
}

// é¸æŠã•ã‚ŒãŸã‚µãƒ¼ãƒ“ã‚¹æƒ…å ±ã®ç¢ºèª
$service_ids = array_column($services, 'service_id');
$service_total_duration = array_sum(array_column($services, 'duration'));
$service_total_price = array_sum(array_column($services, 'price'));

// ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’ä¿å­˜
function debug_log($message) {
    error_log($message);
    file_put_contents(__DIR__ . '/debug.txt', date('Y-m-d H:i:s') . ' - ' . $message . "\n", FILE_APPEND);
}

// ãƒ‡ãƒãƒƒã‚°æƒ…å ±
debug_log('äºˆç´„å‡¦ç†é–‹å§‹...');
debug_log('ã‚µãƒ­ãƒ³ID: ' . $salon_id);
debug_log('é¸æŠã‚µãƒ¼ãƒ“ã‚¹: ' . json_encode($services));

// ã‚¹ã‚¿ãƒƒãƒ•ã®å–å¾—
try {
    // é¸æŠã—ãŸã‚µãƒ¼ãƒ“ã‚¹ã«å¯¾å¿œã—ã¦ã„ã‚‹ã‚¹ã‚¿ãƒƒãƒ•ã®ã¿å–å¾—
    $placeholders = implode(',', array_fill(0, count($service_ids), '?'));
    
    // ãƒ‡ãƒãƒƒã‚°ç”¨
    debug_log("ã‚µãƒ¼ãƒ“ã‚¹ID: " . implode(',', $service_ids));
    
    // ã‚¯ã‚¨ãƒªã‚’ä¿®æ­£ï¼šã‚µãƒ¼ãƒ“ã‚¹ã®ä¸€éƒ¨ã ã‘ã§ã‚‚ãƒãƒƒãƒã™ã‚‹ã‚ˆã†ã«HAVINGã‚’èª¿æ•´
    $query = "
        SELECT 
            s.staff_id,
            CONCAT(s.first_name, ' ', s.last_name) as name,
            '' as photo_url,
            s.status,
            '' as profile,
            COUNT(DISTINCT ss.service_id) as matching_services_count
        FROM staff s
        JOIN staff_services ss ON s.staff_id = ss.staff_id
        WHERE s.salon_id = ? 
        AND s.status = 'active'
        AND ss.service_id IN ($placeholders)
        AND ss.is_active = 1
        GROUP BY s.staff_id
        HAVING matching_services_count > 0
        ORDER BY matching_services_count DESC
    ";
    
    $params = [$salon_id];
    foreach ($service_ids as $id) {
        $params[] = $id;
    }
    
    $stmt = $conn->prepare($query);
    $stmt->execute($params);
    $staffs = $stmt->fetchAll(PDO::FETCH_ASSOC);
    
    // ãƒ‡ãƒãƒƒã‚°ç”¨
    debug_log("ã‚¹ã‚¿ãƒƒãƒ•æ•°: " . count($staffs));
    debug_log("ã‚¹ã‚¿ãƒƒãƒ•ãƒ‡ãƒ¼ã‚¿: " . json_encode($staffs));

    // ã‚¹ã‚¿ãƒƒãƒ•ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã‚„ãƒ‡ãƒ¼ã‚¿ãŒä¸å®Œå…¨ãªå ´åˆã¯ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦åˆ¥ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œ
    if (empty($staffs)) {
        debug_log("ã‚µãƒ¼ãƒ“ã‚¹ã«å¯¾å¿œã™ã‚‹ã‚¹ã‚¿ãƒƒãƒ•ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã€å…¨ã‚¹ã‚¿ãƒƒãƒ•ã‚’å–å¾—ã—ã¾ã™");
        
        // å…¨ã‚¹ã‚¿ãƒƒãƒ•ã‚’å–å¾—ã™ã‚‹ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚¯ã‚¨ãƒª
        $fallback_query = "
            SELECT 
                s.staff_id,
                CONCAT(s.first_name, ' ', s.last_name) as name,
                '' as photo_url,
                s.status,
                '' as profile
            FROM staff s
            WHERE s.salon_id = ? 
            AND s.status = 'active'
            ORDER BY s.staff_id
            LIMIT 10
        ";
        
        $stmt = $conn->prepare($fallback_query);
        $stmt->bindParam(1, $salon_id);
        $stmt->execute();
        $staffs = $stmt->fetchAll(PDO::FETCH_ASSOC);
        
        if (empty($staffs)) {
            debug_log("ã‚¹ã‚¿ãƒƒãƒ•ãŒä¸€äººã‚‚è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
            throw new Exception("ã‚µãƒ¼ãƒ“ã‚¹ã«å¯¾å¿œã—ã¦ã„ã‚‹ã‚¹ã‚¿ãƒƒãƒ•ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
        }
    }
    
    // å„ã‚¹ã‚¿ãƒƒãƒ•ã«å¯¾ã—ã¦æ‹…å½“ã‚µãƒ¼ãƒ“ã‚¹ã‚’è©³ç´°ã«å–å¾—
    foreach ($staffs as &$staff) {
        $staff_id = $staff['staff_id'];
        
        // ã‚¹ã‚¿ãƒƒãƒ•ãŒæ‹…å½“ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹IDã‚’å–å¾—
        $stmt = $conn->prepare("
            SELECT service_id 
            FROM staff_services 
            WHERE staff_id = ? 
            AND is_active = 1
        ");
        $stmt->bindParam(1, $staff_id);
        $stmt->execute();
        $staff_services = $stmt->fetchAll(PDO::FETCH_COLUMN);
        
        // ã‚¹ã‚¿ãƒƒãƒ•ã®æƒ…å ±ã«æ‹…å½“ã‚µãƒ¼ãƒ“ã‚¹ã‚’è¿½åŠ 
        $staff['services'] = $staff_services;
        
        debug_log("ã‚¹ã‚¿ãƒƒãƒ•ID " . $staff_id . " ã®æ‹…å½“ã‚µãƒ¼ãƒ“ã‚¹: " . json_encode($staff_services));
    }
    
} catch (Exception $e) {
    debug_log("ã‚¹ã‚¿ãƒƒãƒ•å–å¾—ã‚¨ãƒ©ãƒ¼ï¼š" . $e->getMessage());
    error_log("ã‚¹ã‚¿ãƒƒãƒ•å–å¾—ã‚¨ãƒ©ãƒ¼ï¼š" . $e->getMessage());
    $_SESSION['error_message'] = $e->getMessage();
    header('Location: error.php');
    exit;
}

// å–¶æ¥­æ—¥ã®å–å¾—ï¼ˆ30æ—¥åˆ†ï¼‰
$today = date('Y-m-d');
$start_date = $today;
$end_date = date('Y-m-d', strtotime($today . ' + 29 days'));

$calendar_days = [];
$current_date = new DateTime($start_date);
$end_date_obj = new DateTime($end_date);

// å•é¡Œã®ãƒ‡ãƒãƒƒã‚°è¡¨ç¤º
debug_log("å–¶æ¥­æ™‚é–“: " . json_encode($business_hours));

// å–¶æ¥­æ™‚é–“ãŒJSONå½¢å¼ã§ãªã„å ´åˆã¯ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
if (empty($business_hours)) {
    $business_hours = [
        "1" => ["start" => "10:00", "end" => "19:00"], // æœˆæ›œæ—¥
        "2" => ["start" => "10:00", "end" => "19:00"], // ç«æ›œæ—¥
        "3" => ["start" => "10:00", "end" => "19:00"], // æ°´æ›œæ—¥
        "4" => ["start" => "10:00", "end" => "19:00"], // æœ¨æ›œæ—¥
        "5" => ["start" => "10:00", "end" => "19:00"], // é‡‘æ›œæ—¥
        "6" => ["start" => "10:00", "end" => "19:00"], // åœŸæ›œæ—¥
        "7" => ["start" => "10:00", "end" => "18:00"]  // æ—¥æ›œæ—¥
    ];
    debug_log("å–¶æ¥­æ™‚é–“ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ãŸã‚ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨ã—ã¾ã™");
}

// ã‚¹ã‚¿ãƒƒãƒ•ã®å–å¾—å¾Œã€ã‚¹ã‚¿ãƒƒãƒ•ã‚·ãƒ•ãƒˆæƒ…å ±ã‚’å–å¾—
try {
    // ã‚¹ã‚¿ãƒƒãƒ•ã®ã‚·ãƒ•ãƒˆæƒ…å ±å–å¾—ï¼ˆç¾åœ¨æ—¥ä»˜ã‹ã‚‰30æ—¥é–“ï¼‰
    $stmt = $conn->prepare("
        SELECT 
            staff_id, 
            shift_date, 
            start_time, 
            end_time,
            status
        FROM staff_shifts
        WHERE salon_id = :salon_id 
        AND shift_date BETWEEN :start_date AND :end_date
        AND status = 'active'
    ");
    $stmt->bindParam(':salon_id', $salon_id);
    $stmt->bindParam(':start_date', $start_date);
    $stmt->bindParam(':end_date', $end_date);
    $stmt->execute();
    $staff_shifts = $stmt->fetchAll(PDO::FETCH_ASSOC);
    
    // ã‚¹ã‚¿ãƒƒãƒ•IDã€æ—¥ä»˜ã”ã¨ã«ã‚·ãƒ•ãƒˆæƒ…å ±ã‚’æ•´ç†
    $staff_availability = [];
    foreach ($staff_shifts as $shift) {
        $date = $shift['shift_date'];
        $staff_id = $shift['staff_id'];
        
        if (!isset($staff_availability[$date])) {
            $staff_availability[$date] = [];
        }
        
        $staff_availability[$date][$staff_id] = [
            'start_time' => $shift['start_time'],
            'end_time' => $shift['end_time']
        ];
    }
    
    debug_log("ã‚¹ã‚¿ãƒƒãƒ•ã‚·ãƒ•ãƒˆæƒ…å ±: " . json_encode($staff_availability));
    
} catch (Exception $e) {
    debug_log("ã‚¹ã‚¿ãƒƒãƒ•ã‚·ãƒ•ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼: " . $e->getMessage());
    // ã‚¨ãƒ©ãƒ¼ã§ã‚‚ç¶šè¡Œï¼ˆã‚·ãƒ•ãƒˆãŒãªãã¦ã‚‚å–¶æ¥­æ™‚é–“å†…ã§äºˆç´„å—ä»˜ï¼‰
    $staff_availability = [];
}

// æ›œæ—¥è¡¨è¨˜ã®çµ±ä¸€ï¼ˆPHPã®æ›œæ—¥è¡¨è¨˜: 0=æ—¥æ›œ, 1=æœˆæ›œ, ..., 6=åœŸæ›œï¼‰
while ($current_date <= $end_date_obj) {
    $date_string = $current_date->format('Y-m-d');
    // PHPã®æ›œæ—¥ã¯ 0ï¼ˆæ—¥ï¼‰ï½ 6ï¼ˆåœŸï¼‰ã€DBã®æ›œæ—¥ã‚‚ 0ï¼ˆæ—¥ï¼‰ï½ 6ï¼ˆåœŸï¼‰ã«çµ±ä¸€
    $day_of_week = $current_date->format('w'); 
    
    // å–¶æ¥­æ—¥åˆ¤å®š
    $is_business_day = isset($business_hours[$day_of_week]) && 
                       !empty($business_hours[$day_of_week]['start']) && 
                       !empty($business_hours[$day_of_week]['end']);
    
    // ãƒ‡ãƒãƒƒã‚°ç”¨
    if (!$is_business_day) {
        debug_log($date_string . " ã¯å–¶æ¥­æ—¥ã§ã¯ã‚ã‚Šã¾ã›ã‚“ï¼ˆæ›œæ—¥: " . $day_of_week . "ï¼‰");
    }
    
    $calendar_days[$date_string] = [
        'date' => $date_string,
        'day' => $current_date->format('j'),
        'day_of_week' => $day_of_week,
        'month' => $current_date->format('n'),
        'year' => $current_date->format('Y'),
        'is_business_day' => $is_business_day,
        'is_past' => $date_string < $today
    ];
    
    $current_date->modify('+1 day');
}

// äºˆç´„æ¸ˆã¿æ™‚é–“æ ã®å–å¾—
function getBookedTimeSlots($conn, $salon_id, $start_date, $end_date) {
    $booked_slots = [];
    
    try {
        $stmt = $conn->prepare("
            SELECT 
                a.appointment_date,
                a.start_time,
                a.end_time,
                a.staff_id,
                a.status
            FROM appointments a
            WHERE a.salon_id = :salon_id
            AND a.appointment_date BETWEEN :start_date AND :end_date
            AND a.status NOT IN ('cancelled', 'no-show')
        ");
        $stmt->bindParam(':salon_id', $salon_id);
        $stmt->bindParam(':start_date', $start_date);
        $stmt->bindParam(':end_date', $end_date);
        $stmt->execute();
        
        while ($row = $stmt->fetch(PDO::FETCH_ASSOC)) {
            $date = $row['appointment_date'];
            $staff_id = $row['staff_id'];
            
            if (!isset($booked_slots[$date])) {
                $booked_slots[$date] = [];
            }
            if (!isset($booked_slots[$date][$staff_id])) {
                $booked_slots[$date][$staff_id] = [];
            }
            
            $start_time = $row['start_time'];
            $end_time = $row['end_time'];
            
            // é–‹å§‹æ™‚é–“ã‹ã‚‰çµ‚äº†æ™‚é–“ã¾ã§ã®å…¨ã¦ã®30åˆ†æ ã‚’äºˆç´„æ¸ˆã¿ã¨ã—ã¦ãƒãƒ¼ã‚¯
            $current_time = new DateTime($start_time);
            $end_time_obj = new DateTime($end_time);
            
            while ($current_time < $end_time_obj) {
                $time_key = $current_time->format('H:i');
                $booked_slots[$date][$staff_id][$time_key] = true;
                $current_time->modify('+30 minutes');
            }
        }
        
        debug_log("äºˆç´„æ¸ˆã¿æ™‚é–“æ ï¼š " . json_encode($booked_slots));
        return $booked_slots;
        
    } catch (Exception $e) {
        error_log("äºˆç´„æ¸ˆã¿æ™‚é–“æ å–å¾—ã‚¨ãƒ©ãƒ¼ï¼š" . $e->getMessage());
        debug_log("äºˆç´„æ¸ˆã¿æ™‚é–“æ å–å¾—ã‚¨ãƒ©ãƒ¼ï¼š" . $e->getMessage());
        return [];
    }
}

$booked_time_slots = getBookedTimeSlots($conn, $salon_id, $start_date, $end_date);

// æ™‚é–“æ ç”Ÿæˆã®ãŸã‚ã®æ–°ã—ã„é–¢æ•°ã‚’è¿½åŠ 
function generateTimeSlotsFromRange($start_time, $end_time, $service_duration, $interval = 30) {
    $time_slots = [];
    
    $current_time = new DateTime($start_time);
    $end_time_obj = new DateTime($end_time);
    
    // ã‚µãƒ¼ãƒ“ã‚¹æ™‚é–“åˆ†ã‚’å¼•ã„ã¦ã€æœ€çµ‚é–‹å§‹å¯èƒ½æ™‚é–“ã‚’è¨ˆç®—
    $max_start_time = clone $end_time_obj;
    $max_start_time->modify('-' . $service_duration . ' minutes');
    
    while ($current_time <= $max_start_time) {
        $time_key = $current_time->format('H:i');
        $time_slots[] = $time_key;
        $current_time->modify('+' . $interval . ' minutes');
    }
    
    return $time_slots;
}

// å…ƒã®generateTimeSlotsã®é–¢æ•°ã‚‚æ®‹ã™ï¼ˆæ—¢å­˜ã‚³ãƒ¼ãƒ‰ã‹ã‚‰å‚ç…§ã•ã‚Œã¦ã„ã‚‹ãŸã‚ï¼‰
function generateTimeSlots($business_hours, $day_of_week, $service_duration, $interval = 30) {
    $time_slots = [];
    
    if (!isset($business_hours[$day_of_week]) || 
        empty($business_hours[$day_of_week]['start']) || 
        empty($business_hours[$day_of_week]['end'])) {
        debug_log("æ›œæ—¥ $day_of_week ã®å–¶æ¥­æ™‚é–“ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“");
        return $time_slots;
    }
    
    $start_time = $business_hours[$day_of_week]['start'];
    $end_time = $business_hours[$day_of_week]['end'];
    
    debug_log("æ›œæ—¥ $day_of_week ã®å–¶æ¥­æ™‚é–“: $start_time - $end_time");
    
    return generateTimeSlotsFromRange($start_time, $end_time, $service_duration, $interval);
}

// å„æ—¥ä»˜ã®ã‚¹ã‚¿ãƒƒãƒ•åˆ¥åˆ©ç”¨å¯èƒ½æ™‚é–“æ ã‚’ç”Ÿæˆ
$available_time_slots = [];
$no_available_slots = true; // åˆ©ç”¨å¯èƒ½ãªæ™‚é–“æ ãŒãªã„ã‹ã©ã†ã‹ã‚’è¿½è·¡

foreach ($calendar_days as $date => $day_info) {
    if (!$day_info['is_business_day'] || $day_info['is_past']) {
        continue;
    }
    
    $day_of_week = $day_info['day_of_week'];
    $available_time_slots[$date] = [];
    
    foreach ($staffs as $staff) {
        $staff_id = $staff['staff_id'];
        $available_time_slots[$date][$staff_id] = [];
        
        // æ™‚é–“æ ã®ç”Ÿæˆæ–¹æ³•ã‚’æ±ºå®š
        // 1. ã‚¹ã‚¿ãƒƒãƒ•ã®ã‚·ãƒ•ãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ãã‚Œã‚’å„ªå…ˆ
        // 2. ã‚·ãƒ•ãƒˆãŒãªã‘ã‚Œã°ã‚µãƒ­ãƒ³ã®å–¶æ¥­æ™‚é–“ã‚’ä½¿ç”¨
        
        $time_slots_to_check = [];
        
        if (isset($staff_availability[$date][$staff_id])) {
            // ã‚¹ã‚¿ãƒƒãƒ•ã®ã‚·ãƒ•ãƒˆã«åŸºã¥ã„ã¦æ™‚é–“æ ã‚’ç”Ÿæˆ
            $shift_start = $staff_availability[$date][$staff_id]['start_time'];
            $shift_end = $staff_availability[$date][$staff_id]['end_time'];
            
            debug_log("ã‚¹ã‚¿ãƒƒãƒ•ID " . $staff_id . " ã® " . $date . " ã®ã‚·ãƒ•ãƒˆ: " . $shift_start . " - " . $shift_end);
            
            $time_slots_to_check = generateTimeSlotsFromRange(
                substr($shift_start, 0, 5), 
                substr($shift_end, 0, 5), 
                $service_total_duration
            );
        } else {
            // ã‚·ãƒ•ãƒˆãŒãªã„å ´åˆã¯ã‚µãƒ­ãƒ³ã®å–¶æ¥­æ™‚é–“ã«åŸºã¥ã„ã¦æ™‚é–“æ ã‚’ç”Ÿæˆ
            $time_slots_to_check = generateTimeSlots($business_hours, $day_of_week, $service_total_duration);
        }
        
        // ä»Šæ—¥ã®å ´åˆã¯ã€ç¾åœ¨æ™‚åˆ»ã‚ˆã‚Šå¾Œã®æ™‚é–“æ ã®ã¿ã‚’åˆ©ç”¨å¯èƒ½ã«ã™ã‚‹
        if ($date === date('Y-m-d')) {
            $current_hour = date('H');
            $current_minute = date('i');
            $filtered_time_slots = [];
            
            foreach ($time_slots_to_check as $time) {
                list($hour, $minute) = explode(':', $time);
                // ç¾åœ¨æ™‚åˆ»ã‚ˆã‚Š1æ™‚é–“å¾Œä»¥é™ã®æ™‚é–“æ ã®ã¿ã‚’å«ã‚ã‚‹
                if ((int)$hour > ((int)$current_hour + 1) || 
                    ((int)$hour === ((int)$current_hour + 1) && (int)$minute >= (int)$current_minute)) {
                    $filtered_time_slots[] = $time;
                }
            }
            
            $time_slots_to_check = $filtered_time_slots;
            debug_log("ä»Šæ—¥ã®åˆ©ç”¨å¯èƒ½æ™‚é–“æ ï¼ˆç¾åœ¨æ™‚åˆ»ä»¥é™ï¼‰: " . json_encode($time_slots_to_check));
        }
        
        // å„æ™‚é–“æ ã«ã¤ã„ã¦ã€äºˆç´„æ¸ˆã¿ã§ãªã„ã‹ãƒã‚§ãƒƒã‚¯
        foreach ($time_slots_to_check as $time) {
            $is_available = true;
            
            // äºˆç´„æ¸ˆã¿ã‚¹ãƒ­ãƒƒãƒˆã‹ãƒã‚§ãƒƒã‚¯
            $time_obj = new DateTime($time);
            $end_time_obj = clone $time_obj;
            $end_time_obj->modify('+' . $service_total_duration . ' minutes');
            
            $current_check = clone $time_obj;
            
            // é–‹å§‹æ™‚é–“ã‹ã‚‰çµ‚äº†æ™‚é–“ã¾ã§ã®å…¨ã¦ã®30åˆ†æ ã‚’ãƒã‚§ãƒƒã‚¯
            while ($current_check < $end_time_obj) {
                $check_key = $current_check->format('H:i');
                
                if (isset($booked_time_slots[$date][$staff_id][$check_key])) {
                    $is_available = false;
                    break;
                }
                
                $current_check->modify('+30 minutes');
            }
            
            if ($is_available) {
                $available_time_slots[$date][$staff_id][] = $time;
                $no_available_slots = false; // å°‘ãªãã¨ã‚‚1ã¤ã®åˆ©ç”¨å¯èƒ½ãªæ™‚é–“æ ãŒã‚ã‚‹
            }
        }
        
        debug_log("ã‚¹ã‚¿ãƒƒãƒ•ID " . $staff_id . " ã® " . $date . " ã®åˆ©ç”¨å¯èƒ½æ™‚é–“æ : " . 
                 json_encode($available_time_slots[$date][$staff_id]));
    }
}

// ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æŒ¿å…¥éƒ¨åˆ†ã‚’å‰Šé™¤ã—ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºç”¨ã®ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
$has_no_slots_message = false;
if ($no_available_slots) {
    $has_no_slots_message = true;
    debug_log("åˆ©ç”¨å¯èƒ½ãªæ™‚é–“æ ãŒä¸€ã¤ã‚‚ã‚ã‚Šã¾ã›ã‚“ã€‚");
}

// é¸æŠä¸­ã®ã‚µãƒ¼ãƒ“ã‚¹æƒ…å ±ã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰å–å¾—
$selected_services = [];
if (isset($_SESSION['booking_services'])) {
    $selected_services = $_SESSION['booking_services'];
}

// ã‚¿ã‚¤ãƒˆãƒ«è¨­å®š
$salon_name = $salon['salon_name'] ?? 'ã‚µãƒ­ãƒ³';
$page_title = $salon_name . " - æ—¥æ™‚é¸æŠ";

// è¿½åŠ CSSãƒ•ã‚¡ã‚¤ãƒ«ã®è¨­å®š
$additional_css = ['css/select_datetime.css'];

// è¿½åŠ JSãƒ•ã‚¡ã‚¤ãƒ«ã®è¨­å®š
$additional_js = ['js/select_datetime.js'];

// ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¹ãƒ†ãƒƒãƒ—ã‚’è¨­å®š
$active_step = 'datetime';

// ç¾åœ¨ã®æ—¥ä»˜ã‹ã‚‰7æ—¥é–“ã®æ—¥ä»˜é…åˆ—ã‚’ä½œæˆ
$dates = [];
$weekdays = ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'];
$today = new DateTime();

for ($i = 0; $i < 7; $i++) {
    $date = clone $today;
    $date->modify("+$i days");
    $dateKey = $date->format('Y-m-d');
    $dates[$dateKey] = [
        'date' => $dateKey,
        'day' => $date->format('j'),
        'month' => $date->format('n'),
        'weekday' => $weekdays[$date->format('N') - 1], // æ—¥æœ¬ã®æ›œæ—¥è¡¨è¨˜ï¼ˆ0: æœˆ - 6: æ—¥ï¼‰
        'is_today' => ($i === 0),
        'is_business_day' => isset($business_hours[$date->format('N')]) && !empty($business_hours[$date->format('N')]['start'])
    ];
}

// ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’èª­ã¿è¾¼ã¿
include 'includes/header.php';
include 'includes/booking_steps.php';
?>

<div class="booking-container">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ† -->
    <div class="booking-header">
        <h1 class="booking-title">æ—¥æ™‚ã‚’é¸æŠ</h1>
        <p class="booking-subtitle">ã”å¸Œæœ›ã®æ—¥ä»˜ã€ã‚¹ã‚¿ãƒƒãƒ•ã€æ™‚é–“ã‚’ãŠé¸ã³ãã ã•ã„</p>
    </div>

    <!-- ãƒ‡ãƒãƒƒã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div id="debug-section" class="debug-section mb-4" style="display: none;">
        <h5>ğŸ ãƒ‡ãƒãƒƒã‚°æƒ…å ±</h5>
        <div>é¸æŠã—ãŸæ—¥ä»˜: <span id="debug-selected-date">æœªé¸æŠ</span></div>
        <div>é¸æŠã—ãŸã‚¹ã‚¿ãƒƒãƒ•: <span id="debug-selected-staff">æœªé¸æŠ</span></div>
        <div>é¸æŠã—ãŸæ™‚é–“: <span id="debug-selected-time">æœªé¸æŠ</span></div>
        <div class="mt-2">
            <button onclick="toggleDebugMode()" class="btn btn-sm btn-secondary">ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿</button>
            <button onclick="testCalendarClick()" class="btn btn-sm btn-info ml-2">ãƒ†ã‚¹ãƒˆé¸æŠå®Ÿè¡Œ</button>
        </div>
        <div class="mt-2">
            <p><strong>ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±:</strong></p>
            <ul>
                <li>ã‚µãƒ¼ãƒ“ã‚¹ç·æ™‚é–“: <?= $service_total_duration ?>åˆ†</li>
                <li>ã‚µãƒ¼ãƒ“ã‚¹ç·é¡: <?= number_format($service_total_price) ?>å††</li>
                <li>ã‚µãƒ­ãƒ³ID: <?= $salon_id ?></li>
            </ul>
        </div>
    </div>

    <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º -->
    <div id="error-message" class="alert alert-danger" style="display: none;">
        <i class="fas fa-exclamation-circle"></i>
        <span id="error-text"></span>
    </div>

    <!-- æ—¥ä»˜é¸æŠéƒ¨åˆ†ï¼ˆã‚¿ãƒ–å½¢å¼ï¼‰ -->
    <section class="booking-section">
        <div class="section-title">
            <h2>1. æ—¥ä»˜ã‚’é¸æŠ</h2>
        </div>
        
        <div class="date-tabs">
            <?php foreach ($dates as $dateStr => $dateInfo): ?>
                <?php 
                    $isDisabled = !$dateInfo['is_business_day']; 
                    $className = 'date-tab' . ($isDisabled ? ' disabled' : '');
                    $onClick = $isDisabled ? '' : 'onclick="selectDate(\'' . $dateStr . '\')"';
                ?>
                <div class="<?= $className ?>" data-date="<?= $dateStr ?>" <?= $onClick ?>>
                    <div class="date-tab-day"><?= $dateInfo['day'] ?></div>
                    <div class="date-tab-weekday"><?= $dateInfo['weekday'] ?></div>
                </div>
            <?php endforeach; ?>
        </div>
    </section>
    
    <!-- ã‚¹ã‚¿ãƒƒãƒ•é¸æŠéƒ¨åˆ† -->
    <section id="staff-selection" class="booking-section" style="display: none;">
        <div class="section-title">
            <h2>2. ã‚¹ã‚¿ãƒƒãƒ•ã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
        </div>
        
        <div class="staff-list">
            <?php if (!empty($staffs)): ?>
                <div class="staff-card" onclick="selectStaff('0')">
                    <div class="staff-header">
                        <div class="staff-avatar" style="background-color: #f5f5f5; color: #757575">
                            æŒ‡å®š
                        </div>
                        <div class="staff-name">æŒ‡åãªã—</div>
                    </div>
                    <div class="staff-details">
                        <div class="available-slots-count">
                            <i class="far fa-clock"></i> ã©ã®ã‚¹ã‚¿ãƒƒãƒ•ã§ã‚‚å¯
                        </div>
                    </div>
                </div>
                
                <?php foreach ($staffs as $staff): ?>
                    <div class="staff-card" onclick="selectStaff(<?= $staff['staff_id'] ?>)">
                        <div class="staff-header">
                            <?php if (!empty($staff['photo_url'])): ?>
                                <img src="<?= htmlspecialchars($staff['photo_url']) ?>" alt="<?= htmlspecialchars($staff['name']) ?>" class="staff-avatar">
                            <?php else: ?>
                                <div class="staff-avatar" style="background-color: #<?= substr(md5($staff['name']), 0, 6); ?>">
                                    <?= mb_substr($staff['name'], 0, 1, 'UTF-8'); ?>
                                </div>
                            <?php endif; ?>
                            <div class="staff-name"><?= htmlspecialchars($staff['name']) ?></div>
                        </div>
                        <div class="staff-details">
                            <div class="available-slots-count">
                                <i class="far fa-clock"></i> æŒ‡åæ–™ 1,000å††
                            </div>
                        </div>
                    </div>
                <?php endforeach; ?>
            <?php else: ?>
                <div class="no-staff-message">ã‚¹ã‚¿ãƒƒãƒ•ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚åˆ¥ã®æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</div>
            <?php endif; ?>
        </div>
    </section>
    
    <!-- æ™‚é–“é¸æŠéƒ¨åˆ† -->
    <section id="time-selection" class="booking-section" style="display: none;">
        <div class="section-title">
            <h2>3. æ¥åº—æ—¥æ™‚ã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
        </div>
        
        <div class="time-slot-description">
            <p>ã”å¸Œæœ›ã®æ¥åº—æ—¥æ™‚ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
        </div>
        
        <?php if ($has_no_slots_message): ?>
        <div class="alert alert-warning" role="alert">
            ç¾åœ¨ã€äºˆç´„å¯èƒ½ãªæ™‚é–“æ ãŒã‚ã‚Šã¾ã›ã‚“ã€‚åˆ¥ã®æ—¥ä»˜ã‚„ã‚¹ã‚¿ãƒƒãƒ•ã‚’é¸æŠã™ã‚‹ã‹ã€ãŠé›»è©±ã§ã®ã”äºˆç´„ã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚
            <br>
            é›»è©±ç•ªå·: <?= htmlspecialchars($salon['phone'] ?? 'æœªè¨­å®š') ?>
        </div>
        <?php endif; ?>
        
        <div class="time-slot-container">
            <div class="time-slot-wrapper">
                <!-- æ™‚é–“æ ã¯JavaScriptã§å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
                <div class="time-slots-grid" id="time-slots-grid">
                    <!-- ã“ã“ã«æ™‚é–“æ ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
            </div>
        </div>
    </section>
    
    <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
    <div class="action-buttons">
        <a href="select_service.php" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> æˆ»ã‚‹
        </a>
        <button id="next-btn" class="btn btn-primary" disabled>
            æ¬¡ã¸ <i class="fas fa-arrow-right"></i>
        </button>
    </div>
</div>

<!-- CSS ã¨JavaScriptã®ã‚¤ãƒ³ã‚¯ãƒ«ãƒ¼ãƒ‰ -->
<link rel="stylesheet" href="css/select_datetime.css">
<style>
/* æ™‚é–“æ ã®ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤ºç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
.time-slots-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 10px;
    margin-top: 20px;
}

.time-slot {
    background-color: #f9f9f9;
    border: 1px solid #e5e7eb;
    border-radius: 8px;
    padding: 12px 8px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s ease;
}

.time-slot:hover {
    background-color: var(--primary-light);
    border-color: var(--primary-color);
    transform: translateY(-2px);
}

.time-slot.selected {
    background-color: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
    transform: translateY(-2px);
    box-shadow: 0 3px 5px rgba(0,0,0,0.1);
}

.no-time-slots {
    grid-column: 1 / -1;
    text-align: center;
    padding: 30px;
    background-color: #f9f9f9;
    border-radius: 8px;
    color: var(--text-secondary);
}
</style>

<!-- JavaScriptã®å¤‰æ•°è¨­å®š -->
<script>
// PHPã®é…åˆ—ã‚’JavaScriptã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦å®šç¾©
var calendarDays = <?= json_encode($calendar_days) ?>;
var staffData = <?= json_encode($staffs) ?>;
var availableTimeSlots = <?= json_encode($available_time_slots) ?>;
var dateData = <?= json_encode($dates) ?>;
var serviceData = <?= json_encode($services) ?>;

// ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°å‡ºåŠ›
console.log('ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ‡ãƒ¼ã‚¿:', calendarDays);
console.log('ã‚¹ã‚¿ãƒƒãƒ•ãƒ‡ãƒ¼ã‚¿:', staffData);
console.log('åˆ©ç”¨å¯èƒ½æ™‚é–“æ :', availableTimeSlots);
console.log('é¸æŠã•ã‚ŒãŸã‚µãƒ¼ãƒ“ã‚¹:', serviceData);

// é¸æŠçŠ¶æ…‹ã‚’è¿½è·¡ã™ã‚‹å¤‰æ•°
var selectedDate = null;
var selectedStaffId = null;
var selectedTime = null;

// æ—¥ä»˜é¸æŠé–¢æ•°
function selectDate(date) {
    console.log('æ—¥ä»˜é¸æŠ:', date);
    
    // ä»¥å‰ã®é¸æŠã‚’è§£é™¤
    document.querySelectorAll('.date-tab').forEach(function(tab) {
        tab.classList.remove('selected');
    });
    
    // æ–°ã—ã„é¸æŠã‚’é©ç”¨
    document.querySelector(`.date-tab[data-date="${date}"]`).classList.add('selected');
    
    // é¸æŠã•ã‚ŒãŸæ—¥ä»˜ã‚’ä¿å­˜
    selectedDate = date;
    
    // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’æ›´æ–°
    document.getElementById('debug-selected-date').textContent = date;
    
    // ã‚¹ã‚¿ãƒƒãƒ•é¸æŠã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
    document.getElementById('staff-selection').style.display = 'block';
    
    // æ™‚é–“é¸æŠã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
    document.getElementById('time-selection').style.display = 'none';
    
    // é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
    selectedStaffId = null;
    selectedTime = null;
    document.getElementById('debug-selected-staff').textContent = 'æœªé¸æŠ';
    document.getElementById('debug-selected-time').textContent = 'æœªé¸æŠ';
    
    // ã‚¹ã‚¿ãƒƒãƒ•ã‚«ãƒ¼ãƒ‰ã®é¸æŠçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
    document.querySelectorAll('.staff-card').forEach(function(card) {
        card.classList.remove('selected');
    });
    
    // æ¬¡ã¸ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
    updateNextButtonState();
    
    // ã“ã®æ—¥ã«åˆ©ç”¨å¯èƒ½ãªã‚¹ã‚¿ãƒƒãƒ•ã ã‘ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
    updateAvailableStaffForDate(date);
    
    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    document.getElementById('staff-selection').scrollIntoView({behavior: 'smooth'});
}

// æŒ‡å®šã•ã‚ŒãŸæ—¥ä»˜ã«åˆ©ç”¨å¯èƒ½ãªã‚¹ã‚¿ãƒƒãƒ•ã‚’æ›´æ–°
function updateAvailableStaffForDate(date) {
    console.log('æ—¥ä»˜ã«åŸºã¥ãã‚¹ã‚¿ãƒƒãƒ•å¯ç”¨æ€§æ›´æ–°:', date);
    
    // åˆ©ç”¨å¯èƒ½ãªæ™‚é–“æ ã‚’æŒã¤ã‚¹ã‚¿ãƒƒãƒ•IDã‚’åé›†
    const availableStaffIds = [];
    if (availableTimeSlots[date]) {
        for (const staffId in availableTimeSlots[date]) {
            if (availableTimeSlots[date][staffId] && availableTimeSlots[date][staffId].length > 0) {
                availableStaffIds.push(staffId);
            }
        }
    }
    
    console.log('åˆ©ç”¨å¯èƒ½ãªã‚¹ã‚¿ãƒƒãƒ•ID:', availableStaffIds);
    
    // å„ã‚¹ã‚¿ãƒƒãƒ•ã‚«ãƒ¼ãƒ‰ã‚’æ›´æ–°
    document.querySelectorAll('.staff-card').forEach(function(card) {
        // æŒ‡åãªã—ã¯å¸¸ã«é¸æŠå¯èƒ½
        if (card.getAttribute('onclick') && card.getAttribute('onclick').includes('selectStaff(0)')) {
            return;
        }
        
        // ã‚¹ã‚¿ãƒƒãƒ•IDã‚’æŠ½å‡º
        const onclickAttr = card.getAttribute('onclick');
        if (!onclickAttr) return;
        
        const match = onclickAttr.match(/selectStaff\((\d+)\)/);
        if (!match) return;
        
        const staffId = match[1];
        
        // åˆ©ç”¨å¯èƒ½ã‹ã©ã†ã‹ã§ã‚¯ãƒ©ã‚¹ã‚’æ›´æ–°
        if (availableStaffIds.includes(staffId)) {
            card.classList.remove('unavailable');
            card.classList.add('available');
            
            // åˆ©ç”¨å¯èƒ½ãªæ™‚é–“æ ã®æ•°ã‚’è¡¨ç¤º
            const timeSlotsCount = availableTimeSlots[date][staffId].length;
            const slotsCountElement = card.querySelector('.available-slots-count');
            if (slotsCountElement) {
                slotsCountElement.innerHTML = `<i class="far fa-clock"></i> äºˆç´„å¯èƒ½æ : ${timeSlotsCount}`;
            }
        } else {
            card.classList.remove('available');
            card.classList.add('unavailable');
            
            const slotsCountElement = card.querySelector('.available-slots-count');
            if (slotsCountElement) {
                slotsCountElement.innerHTML = `<i class="far fa-clock"></i> äºˆç´„æ ãªã—`;
            }
        }
    });
}

// ã‚¹ã‚¿ãƒƒãƒ•é¸æŠé–¢æ•°
function selectStaff(staffId) {
    console.log('ã‚¹ã‚¿ãƒƒãƒ•é¸æŠ:', staffId);
    
    // é¸æŠä¸å¯èƒ½ãªã‚¹ã‚¿ãƒƒãƒ•ãŒé¸æŠã•ã‚ŒãŸå ´åˆã¯å‡¦ç†ã—ãªã„
    if (staffId !== '0') {
        const staffCard = document.querySelector(`.staff-card[onclick*="selectStaff(${staffId})"]`);
        if (staffCard && staffCard.classList.contains('unavailable')) {
            console.log('åˆ©ç”¨ä¸å¯ã®ã‚¹ã‚¿ãƒƒãƒ•ãŒé¸æŠã•ã‚Œã¾ã—ãŸ');
            showError('é¸æŠã•ã‚ŒãŸæ—¥ä»˜ã«ã¯ã“ã®ã‚¹ã‚¿ãƒƒãƒ•ã®äºˆç´„å¯èƒ½æ ãŒã‚ã‚Šã¾ã›ã‚“ã€‚åˆ¥ã®ã‚¹ã‚¿ãƒƒãƒ•ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
            return;
        }
    }
    
    // ä»¥å‰ã®é¸æŠã‚’è§£é™¤
    document.querySelectorAll('.staff-card').forEach(function(card) {
        card.classList.remove('selected');
    });
    
    // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚¹ã‚¿ãƒƒãƒ•ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
    if (staffId === '0') {
        // æŒ‡åãªã—ã®å ´åˆ
        document.querySelector('.staff-card:first-child').classList.add('selected');
    } else {
        // ç‰¹å®šã®ã‚¹ã‚¿ãƒƒãƒ•ã‚’é¸æŠã—ãŸå ´åˆ
        document.querySelectorAll('.staff-card').forEach(function(card) {
            if (card.getAttribute('onclick') && card.getAttribute('onclick').includes(`selectStaff(${staffId})`)) {
                card.classList.add('selected');
            }
        });
    }
    
    // é¸æŠã•ã‚ŒãŸã‚¹ã‚¿ãƒƒãƒ•IDã‚’ä¿å­˜
    selectedStaffId = staffId;
    
    // ã‚¹ã‚¿ãƒƒãƒ•åã‚’ç‰¹å®š
    let staffName = 'æŒ‡åãªã—';
    if (staffId !== '0') {
        const staffObj = staffData.find(s => s.staff_id == staffId);
        if (staffObj) {
            staffName = staffObj.name;
        }
    }
    
    // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’æ›´æ–°
    document.getElementById('debug-selected-staff').textContent = staffName;
    
    // æ™‚é–“é¸æŠã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
    document.getElementById('time-selection').style.display = 'block';
    
    // æ™‚é–“æ ã‚’æ›´æ–°
    updateTimeSlots(selectedDate, staffId);
    
    // æ¬¡ã¸ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
    updateNextButtonState();
    
    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    document.getElementById('time-selection').scrollIntoView({behavior: 'smooth'});
}

// æ™‚é–“æ ã‚’æ›´æ–°
function updateTimeSlots(date, staffId) {
    console.log('æ™‚é–“æ æ›´æ–°:', { date, staffId });
    
    // æ™‚é–“æ ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¯ãƒªã‚¢
    const timeGrid = document.getElementById('time-slots-grid');
    timeGrid.innerHTML = '';
    
    // æ™‚é–“æ ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    let timeSlots = [];
    
    // æŒ‡åãªã—ã®å ´åˆã¯ã€ã™ã¹ã¦ã®ã‚¹ã‚¿ãƒƒãƒ•ã®æ™‚é–“æ ã‚’é›†ç´„
    if (staffId === '0') {
        // å…¨ã‚¹ã‚¿ãƒƒãƒ•ã®æ™‚é–“æ ã‚’é›†ç´„
        const allTimeSlotsSet = new Set();
        
        if (availableTimeSlots[date]) {
            for (const staffId in availableTimeSlots[date]) {
                availableTimeSlots[date][staffId].forEach(slot => allTimeSlotsSet.add(slot));
            }
        }
        
        timeSlots = Array.from(allTimeSlotsSet).sort();
    } else {
        // ç‰¹å®šã®ã‚¹ã‚¿ãƒƒãƒ•ã®æ™‚é–“æ ã‚’å–å¾—
        if (availableTimeSlots[date] && availableTimeSlots[date][staffId]) {
            timeSlots = availableTimeSlots[date][staffId].sort();
        }
    }
    
    console.log('åˆ©ç”¨å¯èƒ½ãªæ™‚é–“æ :', timeSlots);
    
    // æ™‚é–“æ ãŒä¸€ã¤ã‚‚ãªã„å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    if (timeSlots.length === 0) {
        const noSlots = document.createElement('div');
        noSlots.className = 'no-time-slots';
        noSlots.textContent = 'é¸æŠã—ãŸæ—¥ä»˜ã¨ã‚¹ã‚¿ãƒƒãƒ•ã®çµ„ã¿åˆã‚ã›ã§ã¯ã€äºˆç´„å¯èƒ½ãªæ™‚é–“ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
        timeGrid.appendChild(noSlots);
        return;
    }
    
    // æ™‚é–“æ ã”ã¨ã«è¦ç´ ã‚’ä½œæˆ
    timeSlots.forEach(time => {
        const timeSlot = document.createElement('div');
        timeSlot.className = 'time-slot';
        timeSlot.textContent = time;
        timeSlot.onclick = function() {
            selectTime(time);
        };
        timeGrid.appendChild(timeSlot);
    });
}

// æ™‚é–“é¸æŠé–¢æ•°
function selectTime(time) {
    console.log('æ™‚é–“é¸æŠ:', time);
    
    // ä»¥å‰ã®é¸æŠã‚’è§£é™¤
    document.querySelectorAll('.time-slot').forEach(function(slot) {
        slot.classList.remove('selected');
    });
    
    // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸæ™‚é–“ã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
    document.querySelectorAll('.time-slot').forEach(function(slot) {
        if (slot.textContent === time) {
            slot.classList.add('selected');
        }
    });
    
    // é¸æŠã•ã‚ŒãŸæ™‚é–“ã‚’ä¿å­˜
    selectedTime = time;
    
    // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’æ›´æ–°
    document.getElementById('debug-selected-time').textContent = time;
    
    // æ¬¡ã¸ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
    updateNextButtonState();
}

// æ¬¡ã¸ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
function updateNextButtonState() {
    const isValid = selectedDate && selectedStaffId && selectedTime;
    document.getElementById('next-btn').disabled = !isValid;
    
    console.log('é¸æŠçŠ¶æ…‹æ›´æ–°:', { 
        isValid,
        selectedDate,
        selectedStaffId,
        selectedTime
    });
}

// æ¬¡ã¸ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
document.getElementById('next-btn').addEventListener('click', function() {
    if (selectedDate && selectedStaffId && selectedTime) {
        // é¸æŠã—ãŸæƒ…å ±ã®ç¢ºèª
        console.log('é€ä¿¡äºˆå®šã®äºˆç´„æƒ…å ±:', {
            date: selectedDate,
            staffId: selectedStaffId,
            time: selectedTime,
            serviceIds: serviceData.map(s => s.service_id),
            totalDuration: serviceData.reduce((sum, s) => sum + parseInt(s.duration), 0),
            totalPrice: serviceData.reduce((sum, s) => sum + parseInt(s.price), 0)
        });
        
        // Ajaxé€šä¿¡ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ä¿å­˜
        const xhr = new XMLHttpRequest();
        xhr.open('POST', 'save_datetime_session.php', true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
        xhr.onload = function() {
            if (xhr.status === 200) {
                try {
                    const response = JSON.parse(xhr.responseText);
                    if (response.success) {
                        // æ¬¡ã®ãƒšãƒ¼ã‚¸ã¸ç§»å‹•
                        window.location.href = 'input_info.php';
                    } else {
                        showError(response.message || 'ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                    }
                } catch (e) {
                    showError('å¿œç­”ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                    console.error('JSONè§£æã‚¨ãƒ©ãƒ¼:', e, xhr.responseText);
                }
            } else {
                showError('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                console.error('HTTPã‚¨ãƒ©ãƒ¼:', xhr.status);
            }
        };
        xhr.onerror = function() {
            showError('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
            console.error('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼');
        };
        
        const data = `selected_date=${encodeURIComponent(selectedDate)}&selected_staff_id=${encodeURIComponent(selectedStaffId)}&selected_time=${encodeURIComponent(selectedTime)}`;
        xhr.send(data);
        
        console.log('é€ä¿¡ãƒ‡ãƒ¼ã‚¿:', data);
    } else {
        showError('æ—¥ä»˜ã€ã‚¹ã‚¿ãƒƒãƒ•ã€æ™‚é–“ã‚’ã™ã¹ã¦é¸æŠã—ã¦ãã ã•ã„ã€‚');
    }
});

// ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã®åˆ‡ã‚Šæ›¿ãˆ
function toggleDebugMode() {
    const debugSection = document.getElementById('debug-section');
    if (debugSection.style.display === 'none') {
        debugSection.style.display = 'block';
        localStorage.setItem('debugMode', 'enabled');
    } else {
        debugSection.style.display = 'none';
        localStorage.setItem('debugMode', 'disabled');
    }
}

// ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
function showError(message) {
    document.getElementById('error-text').textContent = message;
    document.getElementById('error-message').style.display = 'block';
    
    console.error('ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º:', message);
    
    // 5ç§’å¾Œã«è‡ªå‹•çš„ã«æ¶ˆãˆã‚‹
    setTimeout(function() {
        document.getElementById('error-message').style.display = 'none';
    }, 5000);
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
document.addEventListener('DOMContentLoaded', function() {
    // ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã®çŠ¶æ…‹ã‚’å¾©å…ƒ
    if (localStorage.getItem('debugMode') === 'enabled') {
        document.getElementById('debug-section').style.display = 'block';
    }
    
    console.log('ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
    console.log('ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰:', localStorage.getItem('debugMode'));
    
    // æ—¥ä»˜ã‚¿ãƒ–ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€è‡ªå‹•çš„ã«æœ€åˆã®åˆ©ç”¨å¯èƒ½ãªæ—¥ä»˜ã‚’é¸æŠ
    if (document.querySelector('.date-tab:not(.disabled)')) {
        const firstAvailableDate = document.querySelector('.date-tab:not(.disabled)').getAttribute('data-date');
        if (firstAvailableDate) {
            selectDate(firstAvailableDate);
        }
    }
});

// ãƒ†ã‚¹ãƒˆé¸æŠå®Ÿè¡Œï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
function testCalendarClick() {
    console.log('ãƒ†ã‚¹ãƒˆé¸æŠå®Ÿè¡Œ');
    
    // ç¾åœ¨åˆ©ç”¨å¯èƒ½ãªæ—¥ä»˜ã‚’æ¢ã™
    let availableDate = null;
    
    // æ—¥ä»˜ã®å–å¾—
    for (const date in availableTimeSlots) {
        if (Object.keys(availableTimeSlots[date]).length > 0) {
            availableDate = date;
            break;
        }
    }
    
    if (!availableDate) {
        console.log('åˆ©ç”¨å¯èƒ½ãªæ—¥ä»˜ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        showError('ãƒ†ã‚¹ãƒˆé¸æŠç”¨ã®åˆ©ç”¨å¯èƒ½ãªæ—¥ä»˜ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
        return;
    }
    
    console.log('åˆ©ç”¨å¯èƒ½ãªæ—¥ä»˜:', availableDate);
    
    // æ—¥ä»˜é¸æŠ
    selectDate(availableDate);
    
    // å¯¾å¿œã™ã‚‹DOMã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆã‚’å¼·åˆ¶çš„ã«é¸æŠ
    const dateTab = document.querySelector(`.date-tab[data-date="${availableDate}"]`);
    if (dateTab) {
        dateTab.classList.add('selected');
    }
    
    // ã‚¹ã‚¿ãƒƒãƒ•ã‚’æ¢ã™
    let availableStaffId = null;
    
    for (const staffId in availableTimeSlots[availableDate]) {
        if (availableTimeSlots[availableDate][staffId] && 
            availableTimeSlots[availableDate][staffId].length > 0) {
            availableStaffId = staffId;
            break;
        }
    }
    
    if (!availableStaffId) {
        console.log('åˆ©ç”¨å¯èƒ½ãªã‚¹ã‚¿ãƒƒãƒ•ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        // ã‚¹ã‚¿ãƒƒãƒ•ãŒè¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°æŒ‡åãªã—ã‚’é¸æŠ
        availableStaffId = '0';
    }
    
    console.log('åˆ©ç”¨å¯èƒ½ãªã‚¹ã‚¿ãƒƒãƒ•ID:', availableStaffId);
    
    // ã‚¹ã‚¿ãƒƒãƒ•é¸æŠ
    selectStaff(availableStaffId);
    
    // æ™‚é–“æ ã‚’å–å¾—
    let availableTime = null;
    
    if (availableStaffId === '0') {
        // æŒ‡åãªã—ã®å ´åˆã¯å…¨ã‚¹ã‚¿ãƒƒãƒ•ã®æ™‚é–“æ ã‚’ç¢ºèª
        for (const staffId in availableTimeSlots[availableDate]) {
            if (availableTimeSlots[availableDate][staffId] && 
                availableTimeSlots[availableDate][staffId].length > 0) {
                availableTime = availableTimeSlots[availableDate][staffId][0];
                break;
            }
        }
    } else {
        // ç‰¹å®šã®ã‚¹ã‚¿ãƒƒãƒ•ã®å ´åˆ
        if (availableTimeSlots[availableDate][availableStaffId] && 
            availableTimeSlots[availableDate][availableStaffId].length > 0) {
            availableTime = availableTimeSlots[availableDate][availableStaffId][0];
        }
    }
    
    if (!availableTime) {
        console.log('åˆ©ç”¨å¯èƒ½ãªæ™‚é–“æ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        showError('ãƒ†ã‚¹ãƒˆé¸æŠç”¨ã®åˆ©ç”¨å¯èƒ½ãªæ™‚é–“æ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
        return;
    }
    
    console.log('åˆ©ç”¨å¯èƒ½ãªæ™‚é–“:', availableTime);
    
    // æ™‚é–“é¸æŠ
    setTimeout(function() {
        selectTime(availableTime);
        
        console.log('ãƒ†ã‚¹ãƒˆé¸æŠå®Œäº†', {
            date: availableDate,
            staffId: availableStaffId,
            time: availableTime
        });
    }, 500);
}
</script>

<?php
// ãƒ•ãƒƒã‚¿ãƒ¼ã‚’èª­ã¿è¾¼ã¿
include 'includes/footer.php';
?> 
</html> 